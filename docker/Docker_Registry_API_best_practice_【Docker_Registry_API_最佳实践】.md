![](https://i-blog.csdnimg.cn/direct/601cbfb490b44fb29e2137eb3dd695ab.jpeg#pic_center)





**ğŸ‘‹ è¿™ç¯‡æ–‡ç« å†…å®¹ï¼šå®ç°shell è„šæœ¬æ‰¹é‡æ¸…ç†docker registryçš„é•œåƒã€‚**

ğŸ””ï¼šä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»ï¼š[https://github.com/Ghostwritten/registry-clean.git](https://github.com/Ghostwritten/registry-clean.git)
# 1. å®‰è£… docker 

- [docker å®‰è£…](https://blog.csdn.net/xixihahalelehehe/article/details/104293170)


# 2. é…ç½® docker

```bash
$ cat /etc/docker/daemon.json 
{
   "exec-opts": ["native.cgroupdriver=systemd"],
   "insecure-registries": ["registry.ghostwritten.com"],
   "live-restore": true,
   "log-driver": "json-file",
   "log-opts": {
     "max-size":  "100m",
     "max-file": "5"
    }
 }

# é…ç½®ä»£ç†
$ cat /usr/lib/systemd/system/docker.service.d/proxy.conf 
[Service]
Environment="HTTP_PROXY=http://192.168.21.101:7890"
Environment="HTTPS_PROXY=http://192.168.21.101:7890"
Environment="NO_PROXY=localhost,127.0.0.1,.coding.net,.tencentyun.com,.myqcloud.com,*.bsgchina.com"
```

```bash
$ systemctl daemon-reload && systemctl restart docker
```

# 4. é…ç½®åŸŸåè§£æ

æœåŠ¡ç«¯(192.168.21.2)é…ç½®
```bash
$ cat  /etc/unbound/unbound.conf
...
    local-data: "registry.ghostwritten.com A 192.168.21.25"
    local-data-ptr: "192.168.21.25 registry.ghostwritten.com"
....

$ systemctl restart unbound
```

å®¢æˆ·ç«¯

```bash
$ cat /etc/resolv.conf 
# Generated by NetworkManager
nameserver 192.168.21.2
```

# 5. éƒ¨ç½² registry

æµ‹è¯•åˆ é™¤é•œåƒ

```bash
$ docker run -tid --restart=always --name registry -p 80:5000 -e REGISTRY_COMPATIBILITY_SCHEMA1_ENABLED=true -e REGISTRY_STORAGE_DELETE_ENABLED=true -v /data/registry:/var/lib/registry registry:latest

```


# 6. Registry API ç®¡ç†

```bash

$ curl  -q -s   'http://registry.ghostwritten.com/v2/registry/tags/list' | jq .
{
  "name": "registry",
  "tags": [
    "latest"
  ]
}

$ curl -I -X GET  'http://registry.ghostwritten.com/v2/registry/manifests/latest'
HTTP/1.1 200 OK
Content-Length: 6863
Content-Type: application/vnd.docker.distribution.manifest.v1+prettyjws
Docker-Content-Digest: sha256:f538bbbf8ff45e9872789dfcfbbcd48a44a9c87d21324595efb4df2e6b666c8c
Docker-Distribution-Api-Version: registry/2.0
Etag: "sha256:f538bbbf8ff45e9872789dfcfbbcd48a44a9c87d21324595efb4df2e6b666c8c"
X-Content-Type-Options: nosniff
Date: Wed, 18 Sep 2024 09:02:51 GMT

é€šè¿‡APIç›´æ¥åŒ¹é…æ ‡ç­¾åˆ é™¤ä¸æ‰é•œåƒ
$ curl -I -X DELETE  http://registry.ghostwritten.com/v2/registry/manifests/latest
HTTP/1.1 400 Bad Request
Content-Type: application/json; charset=utf-8
Docker-Distribution-Api-Version: registry/2.0
X-Content-Type-Options: nosniff
Date: Wed, 18 Sep 2024 08:58:49 GMT
Content-Length: 98

#è·å–ID
$ docker inspect registry.ghostwritten.com/registry:latest | jq -r '.[0].RepoDigests[]' |grep registry.ghostwritten.com | awk -F '@' '{print $2}'
sha256:4d2514be50520c34f3b207fc03dd734a9b72403624d8572f8c40e9185575e453


$ curl -I -X GET  'http://registry.ghostwritten.com/v2/registry/manifests/sha256:4d2514be50520c34f3b207fc03dd734a9b72403624d8572f8c40e9185575e453'
HTTP/1.1 200 OK
Content-Length: 1363
Content-Type: application/vnd.docker.distribution.manifest.v2+json
Docker-Content-Digest: sha256:4d2514be50520c34f3b207fc03dd734a9b72403624d8572f8c40e9185575e453
Docker-Distribution-Api-Version: registry/2.0
Etag: "sha256:4d2514be50520c34f3b207fc03dd734a9b72403624d8572f8c40e9185575e453"
X-Content-Type-Options: nosniff
Date: Wed, 18 Sep 2024 09:12:51 GMT



$ curl -I -X DELETE  'http://registry.ghostwritten.com/v2/registry/manifests/sha256:4d2514be50520c34f3b207fc03dd734a9b72403624d
8572f8c40e9185575e453'
HTTP/1.1 202 Accepted
Docker-Distribution-Api-Version: registry/2.0
X-Content-Type-Options: nosniff
Date: Wed, 18 Sep 2024 09:12:59 GMT
Content-Length: 0

$ curl   -s   'http://registry.ghostwritten.com/v2/_catalog' | jq .
{
  "repositories": [
    "library/busybox",
    "registry"
  ]
}

$ curl  -q -s   'http://registry.ghostwritten.com/v2/registry/tags/list' | jq .
{
  "name": "registry",
  "tags": null
}

$ rm -rf  /data/registry/docker/registry/v2/repositories/registry
$ curl -q -s http://registry.ghostwritten.com/v2/_catalog | jq .
{
  "repositories": [
    "library/busybox"
  ]
}

```
æ¨é€é•œåƒ

```bash
$ docker push registry.ghostwritten.com/registry:latest
The push refers to repository [registry.ghostwritten.com/registry]
3715a40eaff0: Layer already exists 
e48d56ef719d: Layer already exists 
1670fc7fdd22: Layer already exists 
f3965cc04390: Layer already exists 
d62a02444d39: Layer already exists 
latest: digest: sha256:4d2514be50520c34f3b207fc03dd734a9b72403624d8572f8c40e9185575e453 size: 1363
```

æŸ¥è¯¢é•œåƒæ ‡ç­¾

```bash
$ curl  -q -s   'http://registry.ghostwritten.com/v2/registry/tags/list' | jq .
{
  "name": "registry",
  "tags": [
    "latest"
  ]
}
```

# 7. æ‰¹é‡æ¸…ç†é•œåƒ

é¦–å…ˆï¼Œè¿™æ˜¯ä¸€ä¸ªæ¸…ç†çš„æ¼”ç¤ºï¼Œå…ˆæ‰¹é‡æ¨é€é•œåƒå…¥åº“ã€‚æœªæ¥åº”å¯¹å¯èƒ½å­˜åœ¨å„ç±»æƒ…å†µã€‚

- æœ‰æ²¡æœ‰é¡¹ç›®åçš„é•œåƒ
- å¤šä¸ªæ ‡ç­¾çš„é•œåƒ


```bash
$ cat registry-images-push.sh
docker push  registry.ghostwritten.com/demo/nginx:1.26
docker push  registry.ghostwritten.com/demo/nginx:latest
docker push registry.ghostwritten.com/library/busybox:1.36.1
docker push registry.ghostwritten.com/registry:latest
docker push registry.ghostwritten.com/library/busybox:1.35.0
```

æ¨é€é•œåƒå…¥åº“ã€‚

```bash
$ sh registry-images-push.sh
```

è¦åˆ é™¤çš„é•œåƒæˆ‘ä»¬å­˜æ”¾åˆ° registry-images-clean.txt æ–‡ä»¶ä¸­ã€‚æˆ‘ä»¬ä¼šæ£€éªŒä»¥ä¸‹å‡ ç±»åˆ é™¤åœºæ™¯ã€‚

- åˆ é™¤æœ‰ä¸ªå¤šä¸ªæ ‡ç­¾çš„é•œåƒæ£€éªŒæ˜¯å¦ä¼šè¯¯åˆ é™¤ï¼›
- åˆ é™¤æ²¡æœ‰é¡¹ç›®åçš„é•œåƒï¼›
- åˆ é™¤ä¸å­˜åœ¨çš„é•œåƒã€‚

```bash
$ cat registry-images-clean.txt
registry.ghostwritten.com/library/busybox:1.36.1
registry.ghostwritten.com/registry:latest
registry.ghostwritten.com/demo/nginx:1.26
registry.ghostwritten.com/demo/nginx:noexist
```



è¿™ä¸ªè„šæœ¬çš„ç›®çš„æ˜¯ä»Dockeræ³¨å†Œè¡¨ä¸­æ‰¹é‡åˆ é™¤é•œåƒã€‚åœ¨æ‰§è¡Œè„šæœ¬ä¹‹å‰ï¼Œå¿…é¡»åˆ›å»ºä¸€ä¸ªåä¸ºimages.txtçš„æ–‡ä»¶ï¼Œå…¶ä¸­åº”è¯¥åŒ…å«è®¡åˆ’åˆ é™¤çš„æ˜ åƒçš„åç§°ã€‚ä¾‹å¦‚ï¼Œæ–‡ä»¶ä¸­çš„ä¸€ä¸ªæ¡ç›®å¯èƒ½å¦‚ä¸‹æ‰€ç¤º:registry.demo.com/library/nginx:latestã€‚

```bash
$ cat registry-images-clean.sh 
#!/bin/bash

# Script Name: registry-images-clean.sh
# Author: ghostwritten
# Date: 2024-9-18
# Description: This script is designed to facilitate the batch deletion of images from a Docker registry. Prior to executing the script, you must create a file named images.txt, which should contain the names of the images scheduled for deletion. For example, an entry in the file might look like: registry.demo.com/library/nginx:latest. 

name=`basename $0 .sh`

action=$1


images_list() {


image_repos=`cat registry-images-clean.txt  | awk -F '/' '{print $1}' |  uniq`

for image_repo in $image_repos
do 
 repositories=$(curl -q -s http://${image_repo}/v2/_catalog | jq -r '.repositories[]')

 if [[ -n $repositories ]] ; then
  echo "$image_repo é•œåƒä»“åº“åˆ—è¡¨:"

  for repo in $repositories; do

    tags=$(curl -q -s http://${image_repo}/v2/${repo}/tags/list | jq -r '.tags[]')

    if [ -z "$tags" ]; then
        echo "  No tags found"
    else
        for tag in $tags; do
            echo "  $repo:$tag"
        done
    fi
  done
 else
   echo "$image_repo é•œåƒä»“åº“æ˜¯ç©ºåº“."
 fi
done

}

images_rm() {

while IFS= read -r line
do
    image_repo=$(echo "$line" | awk -F '/' '{print $1}')
    
    image_project=$(echo "$line" | awk -F '/' '{ if (NF > 2) print $(NF-1) "/"; else print "" }')


    image_name=$(echo "$line" | awk -F '/' '{print $NF}' | awk -F ':' '{print $1}')
    
    image_tag=$(echo "$line" | awk -F '/' '{print $NF}' | awk -F ':' '{print $2}')


    response=$(curl -s "http://${image_repo}/v2/${image_project}${image_name}/tags/list")
    if echo "$response" | jq -e ".tags | index(\"${image_tag}\")" > /dev/null; then
       echo "é•œåƒ ${image_project}${image_name}:${image_tag} å­˜åœ¨ï¼Œå‡†å¤‡åˆ é™¤..."

       source_data=`docker inspect registry | jq -r '.[0].Mounts[] | select(.Type == "bind") | .Source'`
       MANIFEST_DIGEST=`ls ${source_data}/docker/registry/v2/repositories/${image_project}${image_name}/_manifests/tags/${image_tag}/index/sha256/`

       curl -s -I -X DELETE  "http://${image_repo}/v2/${image_project}${image_name}/manifests/sha256:${MANIFEST_DIGEST}" 2>&1 > /dev/null

    
      response=$(curl -s "http://${image_repo}/v2/${image_project}${image_name}/tags/list")
      if ! echo "$response" | jq -e '.tags | length > 0' > /dev/null; then
         rm -rf ${source_data}/docker/registry/v2/repositories/${image_project}${image_name}
      fi
    else
       echo "é•œåƒ ${image_repo}/${image_project}${image_name}:${image_tag} ä¸å­˜åœ¨ã€‚"
fi


done < registry-images-clean.txt


docker exec registry  bin/registry garbage-collect /etc/docker/registry/config.yml  >> /dev/null
docker restart registry


}

case $action in
 l|ls)
        images_list
        ;;
 d|rm)
        images_rm
        ;;
 *)
        echo "Usage: $name [ls|rm]"
        exit 1
        ;;
esac
exit 0
```


é¦–å…ˆï¼Œæ£€æŸ¥å½“å‰registryé•œåƒä»“åº“æœ‰å“ªäº›é•œåƒã€‚

```bash
$ sh registry-images-clean.sh ls
registry.ghostwritten.com é•œåƒä»“åº“åˆ—è¡¨:
  demo/nginx:latest
  demo/nginx:1.26
  library/busybox:1.35.0
  library/busybox:1.36.1
  registry:latest
registest.bsgchina.com é•œåƒä»“åº“æ˜¯ç©ºåº“.
```
ç°åœ¨ï¼Œæˆ‘ä»¬å¼€å§‹åˆ é™¤ registry-images-clean.txt çš„é•œåƒã€‚

```bash
$  registry-images-clean.sh rm
é•œåƒ library/busybox:1.36.1 å­˜åœ¨ï¼Œå‡†å¤‡åˆ é™¤...
é•œåƒ registry:latest å­˜åœ¨ï¼Œå‡†å¤‡åˆ é™¤...
é•œåƒ demo/nginx:1.26 å­˜åœ¨ï¼Œå‡†å¤‡åˆ é™¤...
é•œåƒ registry.ghostwritten.com/demo/nginx:noexist ä¸å­˜åœ¨ã€‚
é•œåƒ demo/nginx:noexist å­˜åœ¨ï¼Œå‡†å¤‡åˆ é™¤...
```

æ‰§è¡Œç»“æŸåï¼Œå†æ¬¡æ£€æŸ¥é•œåƒä»“åº“åˆ—è¡¨ã€‚

```bash
sh registry-images-clean.sh ls
registry.ghostwritten.com é•œåƒä»“åº“åˆ—è¡¨:
  demo/nginx:latest
  library/busybox:1.35.0
registest.bsgchina.com é•œåƒä»“åº“æ˜¯ç©ºåº“.
```

# 8. å…¶ä»–

- é™¤äº†é€šè¿‡API æŸ¥çœ‹registryé•œåƒåˆ—è¡¨ï¼Œä½ å¯ä»¥[éƒ¨ç½²ä¸€ä¸ª registry UI æŸ¥çœ‹é•œåƒ](https://blog.csdn.net/xixihahalelehehe/article/details/107406198)ã€‚
- å¦å¤–ï¼Œå½“ä½ æƒ³è¦è¿ç§»ä¸€å¥—å…·æœ‰è‡ªå·±é•œåƒä»‹è´¨çš„é•œåƒä»“åº“ã€‚ä½ å¯ä»¥å‚è€ƒè¿™ç¯‡[ä¸éœ€è¦æ¨æ‹‰é•œåƒçš„é•œåƒä»“åº“è¿ç§»æ•™ç¨‹](https://ghostwritten.blog.csdn.net/article/details/136328119)ã€‚



å‚è€ƒï¼š

- [Open Container Initiative Distribution Specification](https://github.com/opencontainers/distribution-spec/blob/v1.0.1/spec.md#pull)
- [https://docs.docker.com/registry/#introduction](https://docs.docker.com/registry/#introduction)
- [https://github.com/Ghostwritten/registry-clean.git](https://github.com/Ghostwritten/registry-clean.git)

