
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/57ec11bf807646198367ccd4ae98f582.jpeg)






## 1. Introduction

**registry-clean** is a powerful and efficient solution designed to simplify the management of your Docker image registry.  It enables easy bulk deletion of outdated or unnecessary images, ensuring your registry remains organized and performs optimally. This intuitive script simplifies image lifecycle management, providing peace of mind in fast-paced development environments.  Enhance your Docker registry management experience with registry-clean.


## 2. Features

* **Handles Diverse Image Types:**  Deletes images with or without project names, images with multiple tags, and even non-existent images (reporting appropriately).
* **Safe Deletion:** The script verifies the existence of images before deletion, preventing accidental removals.
* **Garbage Collection:** Performs garbage collection after execution to reclaim disk space.


## 3. Docker Installation

Before proceeding, ensure Docker is installed and configured correctly.

- [Docker Installation Guide](https://blog.csdn.net/xixihahalelehehe/article/details/104293170)  *(Please replace this link with a current, official Docker installation guide.)*


## 4. Docker Configuration

```bash
$ cat /etc/docker/daemon.json
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "insecure-registries": ["registry.ghostwritten.com"],
  "live-restore": true,
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m",
    "max-file": "5"
  }
}
```

If using a proxy, modify the `/usr/lib/systemd/system/docker.service.d/proxy.conf` file:

```bash
$ cat /usr/lib/systemd/system/docker.service.d/proxy.conf
[Service]
Environment="HTTP_PROXY=http://192.168.21.101:7890"
Environment="HTTPS_PROXY=http://192.168.21.101:7890"
Environment="NO_PROXY=localhost,127.0.0.1,.coding.net,.tencentyun.com,.myqcloud.com,*.bsgchina.com"
```

After configuration changes, run the following command:

```bash
$ sudo systemctl daemon-reload && sudo systemctl restart docker
```


## 5. DNS Configuration

To access the private image registry `registry.ghostwritten.com`, configure DNS resolution.

**Server-side (192.168.21.25) Configuration:** Modify the `/etc/unbound/unbound.conf` file, adding the following (adjust IP address as needed):

```bash
$ cat /etc/unbound/unbound.conf
...
local-data: "registry.ghostwritten.com A 192.168.21.25"
local-data-ptr: "192.168.21.25 registry.ghostwritten.com"
...
```

Restart the Unbound service:

```bash
$ sudo systemctl restart unbound
```

**Client-side Configuration:** Ensure the `/etc/resolv.conf` file points to the correct DNS server (e.g., your server at 192.168.21.2):

```bash
$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 192.168.21.2
```


## 6. Deploying the Registry

Deploy the Docker Registry and enable image deletion:

```bash
$ docker run -d --restart=always --name registry -p 80:5000 -e REGISTRY_COMPATIBILITY_SCHEMA1_ENABLED=true -e REGISTRY_STORAGE_DELETE_ENABLED=true -v /data/registry:/var/lib/registry registry:latest
```

**Note:** Create the `/data/registry` directory beforehand and ensure the Docker container has write permissions.


## 7. Registry API Management

The Docker Registry provides a RESTful API for image management.  Here are some examples:

* **List Image Tags:**

```bash
$ curl -s 'http://registry.ghostwritten.com/v2/registry/tags/list' | jq .
# Example output: {"name": "registry", "tags": ["latest"]}
```

* **Get Image Manifest:**

```bash
$ curl -I -X GET 'http://registry.ghostwritten.com/v2/registry/manifests/latest'
# (HTTP response headers will be displayed here)
```

* **Delete Image (Using Digest):** Direct tag deletion might fail; use the digest instead. First, obtain the image digest using `docker inspect`:

```bash
$ curl -I -X DELETE http://registry.ghostwritten.com/v2/registry/manifests/latest
# (HTTP response headers - likely a 400 error)

$ docker inspect registry.ghostwritten.com/registry:latest | jq -r '.[0].RepoDigests[]' | grep registry.ghostwritten.com | awk -F '@' '{print $2}'
# Output: (SHA256 digest)

$ curl -I -X GET 'http://registry.ghostwritten.com/v2/registry/manifests/<SHA256_digest>'
# (HTTP response headers)

$ curl -I -X DELETE 'http://registry.ghostwritten.com/v2/registry/manifests/<SHA256_digest>'
# (HTTP response headers - likely a 202 Accepted)

$ curl -s 'http://registry.ghostwritten.com/v2/_catalog' | jq .
# Example output: {"repositories": ["library/busybox", "registry"]}

$ curl -q -s 'http://registry.ghostwritten.com/v2/registry/tags/list' | jq .
# Example output: {"name": "registry", "tags": [] or ["latest"]}

$ rm -rf /data/registry/docker/registry/v2/repositories/registry

$ curl -q -s http://registry.ghostwritten.com/v2/_catalog | jq .
# Example output: {"repositories": ["library/busybox"]}
```

Pushing an image:

```bash
$ docker push registry.ghostwritten.com/registry:latest
# (Docker push output)
```

Checking image tags:

```bash
$ curl -q -s 'http://registry.ghostwritten.com/v2/registry/tags/list' | jq .
# Example output: {"name": "registry", "tags": ["latest"]}
```


## 8. Bulk Image Cleanup

This section demonstrates a cleanup process.  First, images are pushed to the registry.  Future scenarios may need to handle various situations: images with or without project names, and images with multiple tags.

```bash
$ cat registry-images-push.sh
docker push registry.ghostwritten.com/demo/nginx:1.26
docker push registry.ghostwritten.com/demo/nginx:latest
docker push registry.ghostwritten.com/library/busybox:1.36.1
docker push registry.ghostwritten.com/registry:latest
docker push registry.ghostwritten.com/library/busybox:1.35.0
```

Push images to the registry:

```bash
$ sh registry-images-push.sh
```

Images to be deleted are listed in `registry-images-clean.txt`. This tests several deletion scenarios: deleting images with multiple tags, images without project names, and non-existent images.

```bash
$ cat registry-images-clean.txt
registry.ghostwritten.com/library/busybox:1.36.1
registry.ghostwritten.com/registry:latest
registry.ghostwritten.com/demo/nginx:1.26
registry.ghostwritten.com/demo/nginx:noexist
```

The `registry-images-clean.sh` script is used for bulk deletion of Docker images. It supports two modes: `ls` (list images) and `rm` (remove images).

**Usage:**

1. **Create `registry-images-clean.txt`:** List images to delete, one per line (e.g., `registry.ghostwritten.com/library/busybox:1.36.1`).
2. **Run the script:**
    * List images: `./registry-images-clean.sh ls`
    * Remove images: `./registry-images-clean.sh rm`

Check current registry images:

```bash
$ sh registry-images-clean.sh ls
# Output: (List of images and tags)
```

Delete images:

```bash
$ sh registry-images-clean.sh rm
# Output: (Messages indicating success or failure for each image deletion)
```

Check the registry again:

```bash
$ sh registry-images-clean.sh ls
# Output: (Updated list of images and tags)
```


## 9. Additional Resources

- Deploy a registry UI for easier management: [Deploying a Registry UI](https://blog.csdn.net/xixihahalelehehe/article/details/107406198) *(Please replace this link with a current, reliable guide.)*
- For migrating a registry: [Registry Migration Tutorial](https://ghostwritten.blog.csdn.net/article/details/136328119) *(Please replace this link with a current, reliable guide.)*


## 10. References

- [Open Container Initiative Distribution Specification](https://github.com/opencontainers/distribution-spec/blob/v1.0.1/spec.md#pull)
- [Docker Registry Documentation](https://docs.docker.com/registry/#introduction)


Remember to replace the outdated links with current, official documentation.  The `registry-images-clean.sh` script provided needs significant improvement for robustness and error handling in a production environment.

